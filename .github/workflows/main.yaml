name: Main Workflow
on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:

  security_scan:
    name: Security Scan
    uses: ./.github/workflows/.security-scan.yaml
    permissions:
      contents: read
      security-events: write

  static_tests:
    name: Static Tests
    uses: ./.github/workflows/.static-tests.yaml

  build:
    name: Build
    uses: ./.github/workflows/.build.yaml
    permissions:
      contents: read
      id-token: write
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    needs:
      - security_scan
      - static_tests

  dynamic_tests:
    name: Dynamic Tests
    uses: ./.github/workflows/.dynamic-tests.yaml
    permissions:
      contents: read
      id-token: write
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      CODSPEED_TOKEN: ${{ secrets.CODSPEED_TOKEN }}
    needs:
      - build
      - static_tests

  examples:
    name: Examples
    uses: ./.github/workflows/.examples.yaml
    permissions:
      contents: read
      id-token: write
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
    needs:
      - build
      - static_tests

  release:
    name: Release
    uses: ./.github/workflows/.release.yaml
    permissions:
      contents: write
      pull-requests: write
      id-token: write
      pages: write
    needs:
      - security_scan
      - static_tests
      - build
      - dynamic_tests
      - examples
    if: ${{ github.repository == 'kamiazya/web-csv-toolbox' && github.ref == 'refs/heads/main' && success() }}
